<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>線上即時客服系統</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #f0f2f5;
        }

        #chat-app {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* 頂部狀態列 */
        .header {
            background: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
            padding-top: max(15px, env(safe-area-inset-top));
            /* 瀏海適配 */
        }

        .header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }

        /* ID 區域 */
        .id-section {
            padding: 15px;
            background: #fdfdfd;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        #my-id {
            background: #fff;
            border: 1px solid #ddd;
            color: #333;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            letter-spacing: 1px;
            font-family: monospace;
            font-size: 16px;
            user-select: all;
            margin-top: 5px;
        }

        /* 連線控制 */
        .conn-controls {
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #eee;
            background: white;
            flex-shrink: 0;
        }

        input[type="text"] {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            outline: none;
            font-size: 16px;
            /* 防止 iOS 縮放 */
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        button:active {
            opacity: 0.8;
        }

        /* 訊息區域 (核心滾動區) */
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #fff;
            font-size: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overscroll-behavior: contain;
        }

        /* 輸入區域 (底部固定) */
        .input-area {
            padding: 10px 15px;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            border-top: 1px solid #eee;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            /* 底部橫條適配 */
            flex-shrink: 0;
        }

        /* 訊息氣泡優化 */
        .msg-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            word-break: break-all;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* 斷線提示遮罩 */
        #offline-alert {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            backdrop-filter: blur(2px);
        }

        /* Mobile Optimization */
        @media (max-width: 600px) {
            #chat-app {
                max-width: 100%;
                border-radius: 0;
                border: none;
            }
        }
    </style>
</head>

<body>

    <div id="chat-app">

        <!-- 頂部狀態列 -->
        <div class="header">
            <h3>線上即時客服系統</h3>
        </div>

        <!-- ID 顯示區域 -->
        <div class="id-section">
            <div
                style="font-size: 13px; color: #666; display: flex; justify-content: space-between; align-items: center;">
                <span>您的客服代碼 (點擊複製)：</span>
                <span id="conn-status-indicator"
                    style="width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block;"></span>
            </div>
            <div id="my-id" onclick="copyId()">
                初始化中...
            </div>
        </div>

        <!-- 連線控制項 -->
        <div class="conn-controls">
            <input type="text" id="target-id" placeholder="輸入客服/客戶代碼" style="flex: 1;">
            <button id="connect-btn" style="background: #007bff; color: white; white-space: nowrap;">開始對話</button>
        </div>

        <!-- 訊息對話框 -->
        <div id="messages">
            <div style="text-align: center; color: #aaa; font-size: 12px; margin-top: 20px;">
                系統：歡迎使用線上客服系統。<br>請輸入代碼開始通話。
            </div>
        </div>

        <!-- 輸入區域 -->
        <div class="input-area">
            <input type="text" id="message-input" placeholder="請輸入訊息..." style="flex: 1;" disabled>
            <button id="send-btn" style="background: #007bff; color: white;" disabled>傳送</button>
        </div>

        <!-- 斷線提示 -->
        <div id="offline-alert">
            <div
                style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px; color: #dc3545;">⚠️ 通話已結束</h4>
                <p style="margin: 0 0 15px; font-size: 14px; color: #666;">對方已離開對話或網路中斷。</p>
                <button onclick="location.reload()" style="background: #6c757d; color: white;">重新整理頁面</button>
            </div>
        </div>

    </div>

    <!-- 載入 PeerJS 核心 -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

    <script>
        const myIdDisplay = document.getElementById('my-id');
        const targetIdInput = document.getElementById('target-id');
        const connectBtn = document.getElementById('connect-btn');
        const msgInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const msgBox = document.getElementById('messages');
        const offlineAlert = document.getElementById('offline-alert');

        // 產生 8 碼亂數 ID (A-Z, 0-9)
        function generateShortId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // 去除 I,1, O,0 避免混淆
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        const myShorthandId = generateShortId();

        // 1. 初始化 Peer (使用自定義 ID)
        const peer = new Peer(myShorthandId, {
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            },
            debug: 1 // 降低 debug 等級減少干擾
        });

        let activeConn = null;

        // ----------------------
        // Peer 事件監聽 (信令伺服器連線狀態)
        // ----------------------

        peer.on('open', (id) => {
            console.log('My ID: ' + id);
            myIdDisplay.innerText = id;
            myIdDisplay.style.color = "#28a745";
            myIdDisplay.style.borderColor = "#28a745";
            appendStatus("系統：[成功] 已連線至客服伺服器");
        });

        peer.on('error', (err) => {
            console.error('PeerJS Error:', err);
            let errorMsg = "系統錯誤";

            switch (err.type) {
                case 'unavailable-id': // 雖然機率極低，但如果 ID 重複
                    alert("代碼衝突，將自動重新整理以產生新代碼。");
                    location.reload();
                    return;
                case 'peer-unavailable':
                    errorMsg = "找不到該代碼，請確認對方是否在線上。";
                    break;
                case 'disconnected':
                    errorMsg = "與伺服器斷線。";
                    break;
                case 'network':
                    errorMsg = "網路連線異常";
                    break;
                default:
                    errorMsg = err.type;
            }

            appendStatus("⚠️ 系統提示：" + errorMsg);
            if (err.type !== 'peer-unavailable') {
                // alert("系統提示：\n" + errorMsg);
            }
        });

        peer.on('disconnected', () => {
            myIdDisplay.innerText = "連線中斷...";
            myIdDisplay.style.color = "#dc3545";
            peer.reconnect();
        });

        peer.on('close', () => {
            // activeConn = null; 
        });

        // 2. 監聽他人連線 (接收方)
        peer.on('connection', (conn) => {
            if (confirm("接受來自 " + conn.peer + " 的對話請求嗎？")) {
                setupConnection(conn);
            } else {
                conn.close();
            }
        });

        // 3. 按下連線按鈕 (發起方)
        connectBtn.onclick = () => {
            const tid = targetIdInput.value.trim().toUpperCase(); // 自動轉大寫
            if (tid) {
                if (tid === peer.id) {
                    alert("無法與自己對話");
                    return;
                }
                appendStatus("正在連線至 " + tid + "...");
                const conn = peer.connect(tid, {
                    reliable: true
                });
                setupConnection(conn);
            } else {
                alert("請輸入對方代碼");
            }
        };

        // 連線通用邏輯
        function setupConnection(conn) {
            if (activeConn) {
                activeConn.close();
            }
            activeConn = conn;

            conn.on('open', () => {
                appendStatus("✅ 對話已建立");
                msgInput.disabled = false;
                sendBtn.disabled = false;
                msgInput.focus();
                offlineAlert.style.display = "none";
            });

            conn.on('data', (data) => {
                addMessage("對方", data, "#f1f0f0", "flex-start", "#333");
            });

            conn.on('close', () => {
                handlePartnerDisconnect();
            });

            conn.on('error', (err) => {
                appendStatus("連線錯誤");
            });
        }

        function handlePartnerDisconnect() {
            appendStatus("⚠️ 對方已離開對話");
            msgInput.disabled = true;
            sendBtn.disabled = true;
            activeConn = null;

            // 顯示全螢幕提示
            offlineAlert.style.display = "flex";
        }

        // 4. 發送訊息邏輯
        function doSend() {
            const msg = msgInput.value.trim();
            if (msg && activeConn) {
                if (activeConn.open) {
                    activeConn.send(msg);
                    addMessage("我", msg, "#0084ff", "flex-end", "white");
                    msgInput.value = "";
                } else {
                    appendStatus("無法發送：對話已結束");
                }
            }
        }

        sendBtn.onclick = doSend;
        msgInput.onkeypress = (e) => { if (e.key === 'Enter') doSend(); };

        // UI 工具函數
        function addMessage(sender, text, bgColor, align, textColor) {
            const wrap = document.createElement('div');
            wrap.style.display = "flex";
            wrap.style.flexDirection = "column";
            wrap.style.alignItems = align;

            const div = document.createElement('div');
            div.className = "msg-bubble";
            div.style.background = bgColor;
            div.style.color = textColor || "black";

            const span = document.createElement('span');
            span.innerText = text; // XSS Prevention
            div.appendChild(span);

            wrap.appendChild(div);
            msgBox.appendChild(wrap);
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        function appendStatus(text) {
            const div = document.createElement('div');
            div.style.textAlign = "center";
            div.style.fontSize = "12px";
            div.style.color = "#999";
            div.style.margin = "10px 0";
            div.innerText = text;
            msgBox.appendChild(div);
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        function copyId() {
            const id = myIdDisplay.innerText;
            if (id.includes('初始化')) return;
            navigator.clipboard.writeText(id);
            alert("代碼已複製！");
        }
    </script>

</body>

</html>